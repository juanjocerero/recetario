// Ruta: prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Justificación: Se configura para SQLite para el desarrollo local,
  // como se especifica en el plan (M1.3, M2.2).
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Product {
  id                String             @id // Código de barras
  name              String
  normalizedName    String // Para búsqueda case/accent-insensitive
  brand             String?
  imageUrl          String?
  calories          Float?             // Valor por 100g
  fat               Float?             // Valor por 100g
  protein           Float?             // Valor por 100g
  carbs             Float?             // Valor por 100g
  fullPayload       Json?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  recipeIngredients RecipeIngredient[]
}

model CustomIngredient {
  id                String             @id @default(cuid())
  name              String             @unique
  normalizedName    String // Para búsqueda case/accent-insensitive
  calories          Float
  fat               Float
  protein           Float
  carbs             Float
  recipeIngredients RecipeIngredient[]
}

model Recipe {
  id          String             @id @default(cuid())
  title       String
  description String?
  steps       String
  // Justificación (Paso 1.1): Campo para almacenar la URL de la imagen de la receta.
  // Es opcional para permitir recetas sin imagen o para usar la imagen de una URL de referencia.
  imageUrl    String?
  ingredients RecipeIngredient[]
  // Justificación (Paso 1.1): Relación uno-a-muchos para almacenar las URLs de referencia de la receta.
  urls        RecipeUrl[]
}

// Justificación (Paso 1.1): Nuevo modelo para almacenar las URLs de referencia asociadas a una receta.
// Esto sigue las buenas prácticas de normalización de bases de datos.
model RecipeUrl {
  id       String @id @default(cuid())
  url      String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId String

  @@unique([recipeId, url])
}

model RecipeIngredient {
  id                 String            @id @default(cuid())
  recipe             Recipe            @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  recipeId           String
  // Se relaciona directamente con un Product o un CustomIngredient
  product            Product?          @relation(fields: [productId], references: [id])
  productId          String?
  customIngredient   CustomIngredient? @relation(fields: [customIngredientId], references: [id])
  customIngredientId String?
  quantity           Float             // En gramos
}